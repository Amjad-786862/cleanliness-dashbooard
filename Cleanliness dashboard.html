<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- CRITICAL: PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AirportClean">
    <meta name="application-name" content="AirportClean">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#2563eb" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e40af" media="(prefers-color-scheme: dark)">
    <meta name="msapplication-TileColor" content="#2563eb">
    
    <title>Airport Cleanliness</title>
    
    <!-- Manifest with proper scope -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
    
    <style>
        /* Your existing CSS remains the same */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .bg-gradient { background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%); }
        .bg-blue-gradient { background: linear-gradient(90deg, #2563eb 0%, #4f46e5 100%); }
        .container { min-height: 100vh; padding-bottom: 80px; }
        .header { background: linear-gradient(90deg, #2563eb 0%, #4f46e5 100%); color: white; padding: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 20px; font-weight: bold; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .content { padding: 16px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 12px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .btn-group { display: flex; gap: 8px; margin-top: 16px; }
        .btn { flex: 1; padding: 10px 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: #16a34a; color: white; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-red { background: #dc2626; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat-card { background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-card.excellent { background: #16a34a; color: white; }
        .stat-card.good { background: #2563eb; color: white; }
        .stat-card.fair { background: #eab308; color: white; }
        .stat-card.poor { background: #dc2626; color: white; }
        .stat-card.pending { background: #6b7280; color: white; }
        .stat-card.avg { background: #4f46e5; color: white; }
        .stat-label { font-size: 11px; opacity: 0.9; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .section { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; overflow: hidden; }
        .section-header { background: linear-gradient(90deg, #3b82f6 0%, #6366f1 100%); color: white; padding: 16px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-content { padding: 12px; display: none; }
        .section-content.active { display: block; }
        .location-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .location-title { font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .checkbox-group { display: flex; gap: 12px; margin-bottom: 8px; }
        .checkbox-label { display: flex; align-items: center; font-size: 12px; }
        .checkbox-label input { margin-right: 4px; }
        .status-excellent { background: #16a34a; }
        .status-good { background: #2563eb; }
        .status-fair { background: #eab308; }
        .status-poor { background: #dc2626; }
        .status-pending { background: #6b7280; }
        select.status { color: white; font-weight: 600; }
        .diff-positive { background: #dcfce7; color: #166534; }
        .diff-negative { background: #fee2e2; color: #991b1b; }
        .diff-neutral { background: #f3f4f6; color: #6b7280; }
        .diff-display { padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-align: center; }
        @media print { .no-print { display: none !important; } }
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* Install Button Styles */
        #pwaInstallPrompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Android Install Banner */
        #androidInstallBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
        }
        #androidInstallBanner img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }
        #androidInstallBanner div {
            flex: 1;
        }
        #androidInstallBanner h4 {
            margin: 0 0 4px 0;
            color: #1f2937;
        }
        #androidInstallBanner p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }
        #androidInstallBanner button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container bg-gradient">
        <div class="header">
            <h1>‚úàÔ∏è Airport Cleanliness</h1>
            <p>Daily Inspection & Monitoring</p>
        </div>

        <div class="content">
            <div class="card">
                <div class="input-group">
                    <label>üìÖ Date</label>
                    <input type="date" id="date" />
                </div>
                <div class="input-group">
                    <label>üïê Shift</label>
                    <select id="shift">
                        <option value="">Select Shift</option>
                        <option value="morning">Morning (8 AM - 2 PM)</option>
                        <option value="evening">Evening (2 PM - 8 PM)</option>
                        <option value="night">Night (8 PM - 8 AM)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>‚è∞ Time</label>
                    <input type="time" id="time" />
                </div>
                <div class="input-group">
                    <label>üë§ Inspector</label>
                    <input type="text" id="inspector" placeholder="Enter inspector name" />
                </div>
                <div class="btn-group no-print">
                    <button class="btn btn-green" onclick="exportCSV()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        CSV
                    </button>
                    <button class="btn btn-blue" onclick="window.print()">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        Print
                    </button>
                    <button class="btn btn-red" onclick="resetAll()">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Reset
                    </button>
                    
                    <!-- NEW: Manual Install Button -->
                    <button class="btn btn-blue" onclick="showInstallInstructions()" id="manualInstallBtn" style="display: none;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Install App
                    </button>
                </div>
            </div>

            <div class="stats-grid" id="stats">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div id="sections"></div>
        </div>
        
        <!-- PWA Install Floating Button -->
        <button id="pwaInstallPrompt" style="display: none;">
            üì± Install App
        </button>
        
        <!-- Android Install Banner -->
        <div id="androidInstallBanner">
            <img src="icon-192.png" alt="App Icon">
            <div>
                <h4>Airport Cleanliness</h4>
                <p>Install app for offline use & better experience</p>
            </div>
            <button id="installViaMenuBtn">Install</button>
        </div>
        
        <!-- Install Instructions Modal -->
        <div id="installInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; margin: 20px;">
                <h3 style="margin-top: 0;">üì± Install Airport Cleanliness App</h3>
                <div id="iosInstructions" style="display: none;">
                    <p><strong>For iOS (iPhone/iPad):</strong></p>
                    <ol style="padding-left: 20px;">
                        <li>Tap the <strong>Share button</strong> (üì§) at the bottom</li>
                        <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                        <li>Tap <strong>"Add"</strong> in top right corner</li>
                    </ol>
                </div>
                <div id="androidInstructions" style="display: none;">
                    <p><strong>For Android:</strong></p>
                    <ol style="padding-left: 20px;">
                        <li>Tap <strong>Menu (‚ãÆ)</strong> in top right corner</li>
                        <li>Tap <strong>"Install App"</strong> or "Add to Home Screen"</li>
                        <li>Tap <strong>"Install"</strong> to confirm</li>
                    </ol>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        If "Install App" is not visible, visit this page 2-3 times
                    </p>
                </div>
                <button onclick="document.getElementById('installInstructions').style.display='none'" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 8px; margin-top: 15px; font-weight: bold;">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== PWA INSTALLATION LOGIC ====================
        let deferredPrompt;
        const pwaInstallPrompt = document.getElementById('pwaInstallPrompt');
        const androidInstallBanner = document.getElementById('androidInstallBanner');
        const manualInstallBtn = document.getElementById('manualInstallBtn');
        
        // Detect if on mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        // Check if already installed
        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }
        
        // Show appropriate install instructions
        function showInstallInstructions() {
            const modal = document.getElementById('installInstructions');
            const ios = document.getElementById('iosInstructions');
            const android = document.getElementById('androidInstructions');
            
            if (isIOS) {
                ios.style.display = 'block';
                android.style.display = 'none';
            } else {
                ios.style.display = 'none';
                android.style.display = 'block';
            }
            
            modal.style.display = 'flex';
        }
        
        // Listen for install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button on mobile
            if (isMobile && !isPWAInstalled()) {
                // Show floating button after 3 seconds
                setTimeout(() => {
                    pwaInstallPrompt.style.display = 'flex';
                    
                    // Also show manual install button in toolbar
                    manualInstallBtn.style.display = 'flex';
                    
                    // For Android, show bottom banner
                    if (isAndroid && !localStorage.getItem('androidBannerDismissed')) {
                        setTimeout(() => {
                            androidInstallBanner.style.display = 'flex';
                        }, 5000);
                    }
                }, 3000);
            }
        });
        
        // Install button click handler
        pwaInstallPrompt.addEventListener('click', async () => {
            if (!deferredPrompt) {
                showInstallInstructions();
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                pwaInstallPrompt.textContent = '‚úÖ Installed!';
                pwaInstallPrompt.style.background = '#16a34a';
                setTimeout(() => {
                    pwaInstallPrompt.style.display = 'none';
                }, 2000);
            } else {
                console.log('User dismissed the install prompt');
                showInstallInstructions();
            }
            
            deferredPrompt = null;
        });
        
        // Android banner install button
        document.getElementById('installViaMenuBtn').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
            } else {
                showInstallInstructions();
            }
            androidInstallBanner.style.display = 'none';
            localStorage.setItem('androidBannerDismissed', 'true');
        });
        
        // Dismiss android banner
        androidInstallBanner.addEventListener('click', (e) => {
            if (e.target !== document.getElementById('installViaMenuBtn')) {
                androidInstallBanner.style.display = 'none';
                localStorage.setItem('androidBannerDismissed', 'true');
            }
        });
        
        // Detect when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            pwaInstallPrompt.style.display = 'none';
            androidInstallBanner.style.display = 'none';
            manualInstallBtn.style.display = 'none';
            deferredPrompt = null;
        });
        
        // Show manual install button if not already showing
        if (isMobile && !isPWAInstalled()) {
            setTimeout(() => {
                manualInstallBtn.style.display = 'flex';
            }, 5000);
        }
        
        // ==================== SERVICE WORKER REGISTRATION ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        
                        // Check for updates every hour
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // ==================== UPDATED APP LOGIC WITH NEW AREAS ====================
        // Updated areas array with all your specified operational areas
        const areas = [
            { 
                id: 'apron', 
                name: '‚úàÔ∏è Apron Area', 
                locations: [
                    'Apron Area North Side',
                    'Apron Area South Side',
                    'Apron Toilet North Side',
                    'Apron Toilet South Side',
                    'AVIO Bridge Stairs Cleanliness'
                ] 
            },
            { 
                id: 'international', 
                name: 'üåç International Arrival Hall', 
                locations: [
                    'Immigration Area (General)',
                    'Immigration Area - Gents Toilet',
                    'Immigration Area - Ladies Toilet',
                    'Intl. Arrival Hall - Gents Toilet',
                    'Intl. Arrival Hall - Ladies Toilet',
                    'Intl. Arrival Hall - Wheelchair Toilet',
                    'Belts Area',
                    'Exit Area Towards Concourse Hall'
                ] 
            },
            { 
                id: 'domestic', 
                name: 'üè† Domestic Arrival Hall', 
                locations: [
                    'Dom. Arrival Hall (General)',
                    'Dom. Arrival Hall - Gents Toilet',
                    'Dom. Arrival Hall - Ladies Toilet',
                    'Dom. Arrival Hall - Wheelchair Toilet',
                    'Belts Area',
                    'Exit Area Towards Concourse Hall'
                ] 
            },
            { 
                id: 'concourse', 
                name: 'üèõÔ∏è Concourse Hall', 
                locations: [
                    'Concourse North Side',
                    'Concourse South Side',
                    'Concourse - Gents Toilet',
                    'Concourse - Ladies Toilet',
                    'Concourse - Wheelchair Toilet',
                    'Concourse - Janitorial Room (North)',
                    'Concourse - Janitorial Room (South)'
                ] 
            },
            { 
                id: 'parking', 
                name: 'üöó Parking & Roads', 
                locations: [
                    'Parking Area North',
                    'Parking Area South',
                    'Parking Area Central',
                    'VVIP Lanes & Driveways',
                    'Parking Entry/Exit Points',
                    'Entry Roads',
                    'Exit Roads',
                    'Cargo Roads',
                    'Mess Road',
                    'Old Car Parking Area'
                ] 
            }
        ];

        let data = {};

        function init() {
            // Load saved data
            const saved = localStorage.getItem('inspectionData');
            if (saved) {
                data = JSON.parse(saved);
            } else {
                // Initialize all areas and locations with default data
                areas.forEach(area => {
                    area.locations.forEach(loc => {
                        const key = `${area.id}-${loc}`;
                        data[key] = { 
                            status: 'pending', 
                            score: '', 
                            deepClean: false, 
                            routineClean: false, 
                            manpower: '', 
                            material: '', 
                            statedStaff: '', 
                            actualStaff: '', 
                            notes: '' 
                        };
                    });
                });
            }

            // Load form data
            document.getElementById('date').value = localStorage.getItem('date') || new Date().toISOString().split('T')[0];
            document.getElementById('shift').value = localStorage.getItem('shift') || '';
            document.getElementById('time').value = localStorage.getItem('time') || '';
            document.getElementById('inspector').value = localStorage.getItem('inspector') || '';

            renderSections();
            updateStats();

            // Auto-save on input
            document.getElementById('date').addEventListener('change', e => { localStorage.setItem('date', e.target.value); });
            document.getElementById('shift').addEventListener('change', e => { localStorage.setItem('shift', e.target.value); });
            document.getElementById('time').addEventListener('change', e => { localStorage.setItem('time', e.target.value); });
            document.getElementById('inspector').addEventListener('input', e => { localStorage.setItem('inspector', e.target.value); });
            
            // Check if PWA is already installed
            if (isPWAInstalled()) {
                console.log('App is already installed as PWA');
                pwaInstallPrompt.style.display = 'none';
                androidInstallBanner.style.display = 'none';
                manualInstallBtn.style.display = 'none';
            }
        }

        function renderSections() {
            const container = document.getElementById('sections');
            container.innerHTML = areas.map(area => `
                <div class="section">
                    <div class="section-header" onclick="toggleSection('${area.id}')">
                        <span>${area.name}</span>
                        <svg class="icon" id="icon-${area.id}" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="section-content" id="content-${area.id}">
                        ${area.locations.map(loc => renderLocation(area.id, loc)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderLocation(areaId, location) {
            const key = `${areaId}-${location}`;
            const d = data[key];
            const diff = d.actualStaff && d.statedStaff ? parseInt(d.actualStaff) - parseInt(d.statedStaff) : '';
            const diffClass = diff < 0 ? 'diff-negative' : diff > 0 ? 'diff-positive' : 'diff-neutral';

            return `
                <div class="location-card">
                    <div class="location-title">${location}</div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Status</label>
                            <select class="status status-${d.status}" onchange="update('${key}', 'status', this.value)">
                                <option value="pending" ${d.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="excellent" ${d.status === 'excellent' ? 'selected' : ''}>Excellent</option>
                                <option value="good" ${d.status === 'good' ? 'selected' : ''}>Good</option>
                                <option value="fair" ${d.status === 'fair' ? 'selected' : ''}>Fair</option>
                                <option value="poor" ${d.status === 'poor' ? 'selected' : ''}>Poor</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Score (%)</label>
                            <input type="number" value="${d.score}" min="0" max="100" placeholder="0-100" onchange="update('${key}', 'score', this.value)" />
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" ${d.deepClean ? 'checked' : ''} onchange="update('${key}', 'deepClean', this.checked)" />
                            Deep Clean
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" ${d.routineClean ? 'checked' : ''} onchange="update('${key}', 'routineClean', this.checked)" />
                            Routine Clean
                        </label>
                    </div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Manpower</label>
                            <input type="text" value="${d.manpower}" onchange="update('${key}', 'manpower', this.value)" />
                        </div>
                        <div class="input-group">
                            <label>Material</label>
                            <input type="text" value="${d.material}" onchange="update('${key}', 'material', this.value)" />
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>Stated Staff</label>
                            <input type="number" value="${d.statedStaff}" onchange="update('${key}', 'statedStaff', this.value)" />
                        </div>
                        <div class="input-group">
                            <label>Actual Staff</label>
                            <input type="number" value="${d.actualStaff}" onchange="update('${key}', 'actualStaff', this.value)" />
                        </div>
                        <div class="input-group">
                            <label>Difference</label>
                            <div class="diff-display ${diffClass}">${diff !== '' ? (diff > 0 ? '+' + diff : diff) : '-'}</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Notes</label>
                        <textarea rows="2" placeholder="Add notes..." onchange="update('${key}', 'notes', this.value)">${d.notes}</textarea>
                    </div>
                </div>
            `;
        }

        function toggleSection(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isActive = content.classList.contains('active');
            
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section-header svg').forEach(el => el.style.transform = 'rotate(0deg)');
            
            if (!isActive) {
                content.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function update(key, field, value) {
            data[key][field] = value;
            localStorage.setItem('inspectionData', JSON.stringify(data));
            updateStats();
            if (field === 'status' || field === 'actualStaff' || field === 'statedStaff') {
                // Re-render the specific location to update the difference display
                const [areaId, location] = key.split('-');
                const sectionContent = document.getElementById(`content-${areaId}`);
                if (sectionContent) {
                    const locationCard = Array.from(sectionContent.children).find(card => 
                        card.querySelector('.location-title').textContent === location
                    );
                    if (locationCard) {
                        locationCard.outerHTML = renderLocation(areaId, location);
                    }
                }
            }
        }

        function updateStats() {
            const values = Object.values(data);
            const stats = {
                excellent: values.filter(v => v.status === 'excellent').length,
                good: values.filter(v => v.status === 'good').length,
                fair: values.filter(v => v.status === 'fair').length,
                poor: values.filter(v => v.status === 'poor').length,
                pending: values.filter(v => v.status === 'pending').length
            };
            const scores = values.filter(v => v.score !== '').map(v => parseInt(v.score) || 0);
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

            // Create or update stats cards
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card excellent">
                    <div class="stat-label">Excellent</div>
                    <div class="stat-value">${stats.excellent}</div>
                </div>
                <div class="stat-card good">
                    <div class="stat-label">Good</div>
                    <div class="stat-value">${stats.good}</div>
                </div>
                <div class="stat-card fair">
                    <div class="stat-label">Fair</div>
                    <div class="stat-value">${stats.fair}</div>
                </div>
                <div class="stat-card poor">
                    <div class="stat-label">Poor</div>
                    <div class="stat-value">${stats.poor}</div>
                </div>
                <div class="stat-card pending">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">${stats.pending}</div>
                </div>
                <div class="stat-card avg">
                    <div class="stat-label">Avg Score</div>
                    <div class="stat-value">${avgScore}%</div>
                </div>
            `;
        }

        function exportCSV() {
            let csv = 'Date,Shift,Time,Inspector,Area,Location,Status,Score,Deep Clean,Routine Clean,Manpower,Material,Stated Staff,Actual Staff,Difference,Notes\n';
            const date = document.getElementById('date').value;
            const shift = document.getElementById('shift').value;
            const time = document.getElementById('time').value;
            const inspector = document.getElementById('inspector').value;

            areas.forEach(area => {
                area.locations.forEach(loc => {
                    const key = `${area.id}-${loc}`;
                    const d = data[key];
                    const diff = d.actualStaff && d.statedStaff ? parseInt(d.actualStaff) - parseInt(d.statedStaff) : '';
                    csv += `"${date}","${shift}","${time}","${inspector}","${area.name}","${loc}","${d.status}","${d.score}","${d.deepClean}","${d.routineClean}","${d.manpower}","${d.material}","${d.statedStaff}","${d.actualStaff}","${diff}","${d.notes}"\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cleanliness-inspection-${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetAll() {
            if (confirm('Reset all data? This cannot be undone.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
